<!DOCTYPE html>
<html lang="en">
<head>
<title>3D.CITY</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
html { width:100%; height:100%; }
body {  padding:0; margin: 0px; background:#6666e6; font:12px sans-serif; width:100%; height:100%; color:#fff; overflow: hidden;}
#debug{ position:absolute; padding:10px; right:0; bottom:0; text-align:right; width:20%; pointer-events:none; display:block; }
#log{ position:absolute; padding:10px; left:0; bottom:0; width:30%; pointer-events:none; display:block;}
#hub{ position:absolute; top:0; left:0; height:100%; width:100%; pointer-events:none; display:block; text-align:center;}
</style>
<script src="js/three.min.js"></script>
<script src="js/loaders/sea3d.min.js"></script>
<script src="js/ImprovedNoise.js"></script>
<script src="js/noise.js"></script>
<script src="js/view3d.js"></script>
<script src="js/hub.js"></script>

</head>
<body>
<div id="container"></div>
<div id="debug">pre alpha 0.4</div>
<div id="log">loth 2014</div>
<div id="hub"></div>
<script>
var d = document.getElementById('debug');
var l = document.getElementById('log');
var timestep = 1000/30;

var cityWorker, view3d, hub, im;
window.onload = init;

function debug(txt){ d.innerHTML += "<br>"+txt; }
function log(txt){ l.innerHTML = txt || '';  }


function init(){
    view3d = new V3D.Base();
    hub = new HUB.Base();
}



function render() {
    
}



//=======================================
//  3D LOOP
//=======================================

function loop() {
    requestAnimationFrame( loop, view3d.renderer.domElement );
    if(tilesData!==null && newup){ view3d.paintMap(tilesData); newup=false; }
    view3d.renderer.render( view3d.scene, view3d.camera );
}

//=======================================
//  CITY INIT
//=======================================

var ARRAY_TYPE;
if(!ARRAY_TYPE) { ARRAY_TYPE = (typeof Float32Array !== 'undefined') ? Float32Array : Array; }

var tilesData = null;//new ARRAY_TYPE(128*128);
var spriteData = null;
var trans = false;
var newup = false;

function start() {
	im = new Image();
    im.onload = initCity;
    im.src = 'img/tiles.png';
}

function newMap() {
	cityWorker.postMessage({tell:"NEWMAP"});
}

function playMap() {
	hub.initGameHub();
    view3d.startZoom();
    cityWorker.postMessage({tell:"PLAYMAP"});
}

function selectTool(id) {
    view3d.selectTool(id);
}

function sendTool(name) {
    cityWorker.postMessage({tell:"TOOL", name:name});
}

function mapClick() {
    var p = view3d.pos;
    if(p.x>0 && p.z>0) cityWorker.postMessage({tell:"MAPCLICK", x:p.x, y:p.z });
}

function initCity() {
    loop();
    view3d.imageSrc = im;

    cityWorker = new Worker('js/worker.city.js');
    cityWorker.postMessage = cityWorker.webkitPostMessage || cityWorker.postMessage;
    cityWorker.postMessage({tell:"INIT", url:document.location.href.replace(/\/[^/]*$/,"/") + "build/city.3d.min.js"});

    cityWorker.onmessage = function(e) {
        var phase = e.data.tell;
        if( phase == "NEWMAP"){
            view3d.paintMap(e.data.map, e.data.mapSize, e.data.island, true);
            trans = e.data.trans;
            //console.log(trans);
            hub.start();
        }
        if( phase == "BUILD"){
            view3d.build(e.data.x, e.data.y, e.data.id);
        }
        if( phase == "RUN"){
            //var str = new String(e.data.sprites);
            log(e.data.infos.join("\n"));
            //log(e.data.infos.join("\n")+'<br>anims:'+ e.data.anims.length + " | sprites:" + e.data.sprites.length);
            tilesData = e.data.tilesData;

            //if(tilesData!==null) view3d.paintMap(im, tilesData);
            spriteData = e.data.sprites;
            newup = true;
            //log(str.toString());
            if(trans) setTimeout( cityWorker.postMessage({tell:"RUN", tilesData:tilesData},[tilesData.buffer]), timestep); 
        }
    }
}
</script>
</body>
</html>