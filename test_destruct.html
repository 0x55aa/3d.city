<!DOCTYPE html>
<html lang="en">
<head>
<title>3D.CITY destructor</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
html { width:100%; height:100%; }
body {  padding:0; margin: 0px; background:#6666e6; font:12px sans-serif; width:100%; height:100%; color:#fff; overflow: hidden;}
#debug{ position:absolute; padding:10px; right:0; bottom:0; text-align:right; width:20%; pointer-events:none; display:block; }
#log{ position:absolute; padding:10px; left:0; bottom:0; width:30%; pointer-events:none; display:block;}
#hub{ position:absolute; top:0; left:0; height:100%; width:100%; pointer-events:none; display:block; text-align:center;}
#top{ position:absolute; top:0; left:0; height:50px; width:100%; pointer-events:none; display:block; text-align:center; font-size: 30px;}
#bdestroy{ position:absolute; top:50px; left:0; height:50px; width:100%; pointer-events:none; display:block; text-align:center; font-size: 30px;}
</style>
<script src="js/three.min.js"></script>
<script src="js/loaders/sea3d.min.js"></script>
<script src="js/spe.min.js"></script>
<script src="js/view3d.js"></script>
<script src="js/hub.js"></script>

</head>
<body>
<div id="container"></div>
<div id="debug">pre alpha 0.76</div>
<div id="log">loth 2014</div>
<div id="hub"></div>
<div id="top">Click here for new object</div>
<div id="bdestroy">Destroy</div>
<script>
var l = document.getElementById('log');
var view3d;
var obj;
var timestep = 1000/60;
var timer;
var finalColor;
var ncolor = 1;
var reflectionCube;
var isDestroy = false;
window.onload = init;

function init(){
    view3d = new V3D.Base();
    document.addEventListener('click',  function ( e ) { 
    	e.preventDefault(); 
    	if(e.clientY<50) newObject(); 
    	if(e.clientY>50 && e.clientY<100) destroy();
    }, false);
}

function log(txt){ l.innerHTML = txt || '';  }

function start() {
	loop();


	view3d.center = new THREE.Vector3(0,1,0);
	view3d.cam.distance = 10;
	view3d.cam.vertical = 85;
    view3d.moveCamera();

    var path = "img/";
	var format = '.jpg';
	var urls = [
			path + 'ref' + format, path + 'ref' + format,
			path + 'ref' + format, path + 'ref' + format,
			path + 'ref' + format, path + 'ref' + format
		];

	reflectionCube = THREE.ImageUtils.loadTextureCube( urls );
	//reflectionCube.format = THREE.RGBFormat;

	//refractionCube = new THREE.CubeTexture( reflectionCube.image)//, new THREE.CubeRefractionMapping() );
	//refractionCube.format = THREE.RGBFormat;

	obj = view3d.getRandomObject();
	view3d.scene.add(obj);

	obj.material.reflectivity = 0;
	obj.material.combine = THREE.MixOperation;
	obj.material.envMap = reflectionCube;

	var mesh = new THREE.Mesh( new THREE.PlaneGeometry( 60, 60 ), new THREE.MeshBasicMaterial( {color:0xcc7f66} ) );
	mesh.geometry.applyMatrix(new THREE.Matrix4().makeRotationX( - Math.PI / 2 ));
	view3d.scene.add( mesh );

}

function newObject() {
	if(obj !== null ){
		clearInterval(timer);
		obj.geometry.dispose();
		obj.material.dispose();
	    view3d.scene.remove(obj);
	}
	if(particleGroup){
		 particleGroup.removeEmitter(emitter);
        particleGroup.removeEmitter(atmosphereBurnEmitter);
        emitter.reset();
        atmosphereBurnEmitter.reset();
        view3d.scene.remove( particleGroup.mesh );
	}

	obj = view3d.getRandomObject();
	view3d.scene.add(obj);

	obj.material.reflectivity = 0;
	obj.material.combine = THREE.MixOperation;
	obj.material.envMap = reflectionCube;

	isDestroy = false;

	
}

function destroy() {
	if(!isDestroy){
	obj.material.side = THREE.DoubleSide;
	finalColor = new THREE.Color();
	finalColor.setHex(0xcc7f66);
	ncolor = 1;
	initParticles();

	/*obj.material.reflectivity = 0.1;
	obj.material.combine = THREE.MixOperation;
	obj.material.envMap = reflectionCube;*/

	if(timer)clearInterval(timer);
	timer = setInterval(destroyCycle, timestep);

	isDestroy = true;
    }


	/*obj.material.reflectivity =1;
	obj.material.combine = THREE.MixOperation;
	obj.material.envMap = reflectionCube;*/

	//obj.material.color.lerp(finalColor, 0.1);
}

function destroyCycle() {
	var vec = obj.geometry.vertices;

	//var i = obj.geometry.faces.length; 
	var i = obj.geometry.vertices.length;
	log("destroy" + i)
	var v, r, f;

	/*while(i--){
		r = randRange(0, 20);
		f = obj.geometry.faces[i];
		if (vec[f.a].y > 0 ) vec[f.a].y -=r/1000;
		if (vec[f.b].y > 0 ) vec[f.b].y -=r/1000;
		if (vec[f.c].y > 0 ) vec[f.c].y -=r/1000;
	}*/

	
	while(i--){
		r = randRange(10, 20);
		v = obj.geometry.vertices[i];
		if (v.y >0.02 ) v.y-=r/1000;
	}

	//var color = obj.material.color.getHex();
	//if(color>0x000000)
	//obj.material.color.lerp(finalColor, ncolor);//.setHex(color-0x010101);
	//obj.material.color.lerp(finalColor, 0.01);
	if(obj.material.reflectivity<1)obj.material.reflectivity+=0.005;

	obj.geometry.computeFaceNormals();
    obj.geometry.computeVertexNormals();
	obj.geometry.verticesNeedUpdate = true;

}
function randRange(min, max) {
	return Math.floor(Math.random() * (max - min + 1)) + min;
}
function burn() {

}

function loop() {
    requestAnimationFrame( loop, view3d.renderer.domElement );
    /*
    if(view3d.mouse.dragView || view3d.mouse.button===2){
        view3d.dragCenterposition();
    }*/
    if(particleGroup)particleGroup.tick( view3d.clock.getDelta() );
    view3d.renderer.render( view3d.scene, view3d.camera );
}
var emitter, particleGroup, atmosphereBurnEmitter;
var asteroid, asteroidRadius = 0.5, emitterPositionSpread = asteroidRadius * 2;
function initParticles() {
            particleGroup = new SPE.Group({
                texture: THREE.ImageUtils.loadTexture('./img/smoke.png'),
                maxAge: 2,
                depthWrite: 0,
                depthTest: 0,
                transparent: 1
            });

            emitter = new SPE.Emitter({
                type: 'cube',

                radius: asteroidRadius * 1.2,

                position: new THREE.Vector3(0, 0, 0),
                positionSpread: new THREE.Vector3( 1.5, 1, 1.5 ),

                acceleration: new THREE.Vector3(0, 1, 0),
                accelerationSpread: new THREE.Vector3( 0, 0, 0 ),

                velocity: new THREE.Vector3(0, 0, 0),
                velocitySpread: new THREE.Vector3(0, 0, 0),

                // Color tests
                colorStart: new THREE.Color( 'white' ),
                colorStartSpread: new THREE.Vector3(0, 0, 0),

                colorMiddle: new THREE.Color( 'yellow' ),
                colorMiddleSpread: new THREE.Vector3(0, 0, 0),

                colorEnd: new THREE.Color( 'red' ),
                colorEndSpread: new THREE.Vector3(0, 0, 0),

                // Size tests
                sizeStart: asteroidRadius,
                sizeStartSpread: 0,

                sizeMiddle: 10,
                sizeMiddleSpread: 0,

                sizeEnd: 0,
                sizeEndSpread: 0,

                // Opacity tests
                opacityStart: 0,
                opacityStartSpread: 0,
                
                opacityMiddle: 0,
                opacityMiddleSpread: 1,

                opacityEnd: 1,
                opacityEndSpread: 0,

                particleCount: 30,

                // Angle tests
                // angleStart: Math.PI * 0.5,
                // angleStartSpread: Math.PI * 2,

                // angleMiddle: 0,
                // angleMiddleSpread: Math.PI * 2,

                // angleEnd: Math.PI * 1.5,
                // angleEndSpread: Math.PI * 1.5
            });
    

            atmosphereBurnEmitter = new SPE.Emitter({
                type: 'sphere',
                radius:2,
                position: new THREE.Vector3(0, 0.5, 0 ),
                acceleration: new THREE.Vector3( 0, 0.3, 0 ),
                velocitySpread: new THREE.Vector3( 1, 0, 0 ),
                sizeStart:0.3,
                particleCount: 50
            });

           // 

           particleGroup.addEmitter( emitter );
           particleGroup.addEmitter( atmosphereBurnEmitter );

           view3d.scene.add( particleGroup.mesh );

            //document.querySelector('.numParticles').textContent = 'Total particles: ' + emitter.numParticles;
        }

        
</script>
</body>
</html>